<html ><body ><table cellspacing="0" cellpadding="0" border="0" style="font-size: 12px;" ><tr ><td >1: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >;;;; ***********************************************************************</pre></td></tr><tr ><td >2: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >;;;; FILE IDENTIFICATION</pre></td></tr><tr ><td >3: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >;;;;</pre></td></tr><tr ><td >4: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >;;;; Name:          macro.scm</pre></td></tr><tr ><td >5: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >;;;; Project:       Bard</pre></td></tr><tr ><td >6: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >;;;; Purpose:       bard macros</pre></td></tr><tr ><td >7: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >;;;; Author:        mikel evins</pre></td></tr><tr ><td >8: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >;;;; Copyright:     2012 by mikel evins</pre></td></tr><tr ><td >9: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >;;;;</pre></td></tr><tr ><td >10: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >;;;; ***********************************************************************</pre></td></tr><tr ><td >11: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" ></pre></td></tr><tr ><td >12: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >;;; a macro-expander is a function of the form:</pre></td></tr><tr ><td >13: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >;;; (lambda (expr env) ...) =&gt; sexpr</pre></td></tr><tr ><td >14: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" ></pre></td></tr><tr ><td >15: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >(define $bard-macro-functions (make-table test: eq?))</pre></td></tr><tr ><td >16: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" ></pre></td></tr><tr ><td >17: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >(define (%define-macro-function name mfun)</pre></td></tr><tr ><td >18: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >  (table-set! $bard-macro-functions name mfun))</pre></td></tr><tr ><td >19: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" ></pre></td></tr><tr ><td >20: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >(define (%macro-form? expr)</pre></td></tr><tr ><td >21: </td><td align="center" >1.16% </td><td ><pre style="background-color:#a77fd7" >  (and (%list? expr)</pre></td></tr><tr ><td >22: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >       (not (%null? expr))</pre></td></tr><tr ><td >23: </td><td align="center" >1.16% </td><td ><pre style="background-color:#a77fd7" >       (table-ref $bard-macro-functions (%car expr) #f)</pre></td></tr><tr ><td >24: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >       #t))</pre></td></tr><tr ><td >25: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" ></pre></td></tr><tr ><td >26: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >(define (%macroexpand expr)</pre></td></tr><tr ><td >27: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >  (let* ((expander (table-ref $bard-macro-functions (%car expr) #f)))</pre></td></tr><tr ><td >28: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >    (if expander</pre></td></tr><tr ><td >29: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >        (%funcall expander expr)</pre></td></tr><tr ><td >30: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >        (error "undefined macro in expression" expr))))</pre></td></tr><tr ><td >31: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" ></pre></td></tr><tr ><td >32: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >(define (%eval-macro-form expr env)</pre></td></tr><tr ><td >33: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >  (%eval (%macroexpand expr) env))</pre></td></tr><tr ><td >34: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" ></pre></td></tr><tr ><td >35: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >;;; ---------------------------------------------------------------------</pre></td></tr><tr ><td >36: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >;;; standard macros</pre></td></tr><tr ><td >37: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >;;; ---------------------------------------------------------------------</pre></td></tr><tr ><td >38: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" ></pre></td></tr><tr ><td >39: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >(%define-macro-function 'and</pre></td></tr><tr ><td >40: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >                        (lambda (expr)</pre></td></tr><tr ><td >41: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >                          (let ((var (gensym)))</pre></td></tr><tr ><td >42: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >                            (if (%null? (%cdr expr))</pre></td></tr><tr ><td >43: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >                                (%true)</pre></td></tr><tr ><td >44: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >                                (if (%null? (%cddr expr))</pre></td></tr><tr ><td >45: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >                                    `(let ((,var ,(%cadr expr))) (if ,var ,var ,(%false)))</pre></td></tr><tr ><td >46: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >                                    `(let ((,var ,(%cadr expr))) (if ,var (and ,@(%cddr expr)) ,(%false))))))))</pre></td></tr><tr ><td >47: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" ></pre></td></tr><tr ><td >48: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >(%define-macro-function 'or</pre></td></tr><tr ><td >49: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >                        (lambda (expr)</pre></td></tr><tr ><td >50: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >                          (let ((var (gensym)))</pre></td></tr><tr ><td >51: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >                            (if (%null? (%cdr expr))</pre></td></tr><tr ><td >52: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >                                (%false)</pre></td></tr><tr ><td >53: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >                                (if (%null? (%cddr expr))</pre></td></tr><tr ><td >54: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >                                    `(let ((,var ,(%cadr expr))) (if ,var ,var ,(%false)))</pre></td></tr><tr ><td >55: </td><td align="center" ></td><td ><pre style="background-color:#ffffff" >                                    `(let ((,var ,(%cadr expr))) (if ,var ,var (or ,@(%cddr expr)))))))))</pre></td></tr></table></body></html>