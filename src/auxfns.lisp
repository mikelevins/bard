;;; -*- Mode: Lisp; Syntax: Common-Lisp -*-
;;; Code from Paradigms of AI Programming
;;; Copyright (c) 1991 Peter Norvig

;;; File auxfns.lisp: Auxiliary functions used by all other programs
;;; Load this file before running any other programs.

;;;; Implementation-Specific Details

(in-package :bard)

(eval-when (eval compile load)
  #+sbcl
  (progn
    (sb-ext:unlock-package '#:common-lisp)
    (sb-ext:unlock-package '#:common-lisp-user)))

;;;; Macros (formerly in auxmacs.lisp: that file no longer needed)

(eval-when (load eval compile)
  (defmacro once-only (variables &rest body)
    "Returns the code built by BODY.  If any of VARIABLES
  might have side effects, they are evaluated once and stored
  in temporary variables that are then passed to BODY."
    (assert (every #'symbolp variables))
    (let ((temps nil))
      (dotimes (i (length variables)) (push (gensym) temps))
      `(if (every #'side-effect-free? (list .,variables))
	   (progn .,body)
	   (list 'let
	         ,`(list ,@(mapcar #'(lambda (tmp var)
			               `(list ',tmp ,var))
			           temps variables))
	         (let ,(mapcar #'(lambda (var tmp) `(,var ',tmp))
		               variables temps)
	           .,body)))))

  (defun side-effect-free? (exp)
    "Is exp a constant, variable, or function,
  or of the form (THE type x) where x is side-effect-free?"
    (or (atom exp) (constantp exp)
	(starts-with exp 'function)
	(and (starts-with exp 'the)
	     (side-effect-free? (third exp)))))

  (defmacro funcall-if (fn arg)
    (once-only (fn)
	       `(if ,fn (funcall ,fn ,arg) ,arg)))

  (defmacro read-time-case (first-case &rest other-cases)
    "Do the first case, where normally cases are
  specified with #+ or possibly #- marks."
    (declare (ignore other-cases))
    first-case)

  (defun rest2 (x)
    "The rest of a list after the first TWO elements."
    (rest (rest x)))

  (defun starts-with (list x)
    "Is x a list whose first element is x?"
    (and (consp list) (eql (first list) x)))
  )

;;; ---------------------------------------------------------------------
;;; Auxiliary Functions
;;; ---------------------------------------------------------------------

(defun ->symbol (&rest args)
  "Concatenate symbols or strings to form an interned symbol"
  (intern (format nil "狺狎珞┅ㄤ彐躅磲忮徜镳屮痼镳糸镱犰殒铋飑⑵矧屮犴痨瀣磲忮徜п钿屮痼舂蝈趱蝾殒屮痼轶铋飕屮痼殒翳弪轶镱禊镱瀣犷ㄡ钿屮鸨屮鸩殒翳弪狎箦鲥蜥屮痼ㄣ镱è铛祆屮痼殒铋飑è戾铉翳奖屮痼ㄦ轵篝屮痼┅ㄣ镱镳屮痼┅┅换浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇ㄤ彐躅灬篝扉篝⒁弭躜翳灬篝屐屙孱铒灬篝泔铙沐祆镦扉篝ㄦ轵篝灬篝扉篝┅换浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇ㄤ彐躅磲痧孱ㄦ扉篝⒘痧孱翳蝈篚祠镦汜祆轭骖镱遽汨屐屙孱镦扉篝涕脲磲疸镱怩躞弩狃疱钿轭篝遽镦钽镱惝ㄡ痧禊＇狃疱钿磲疸狎骖扉篝┅换浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇换换澡腻怩珑轭硝麴豸漆汩扉豉ㄤ彐鲠溻绛殇螵铋⑸溴铘殒殄蝮躞邃怡溻纰ㄤ彐躅溻ㄩ骘蝽狒篝蜷铉蝈篝狎珞⑿蜷铘溴怩珑轭轭骘殒呐抡赡栳忮孱箴邈殒殄洚麒孱礤礅弪殇溻绛殇螵ㄦ蝈箬扉铄溴怩绛轱ㄡ痧禊＇骘蝽狒溴怩绛轱骘蝽狒篝蜷铉狎珞┅ㄤ彐躅溴怩é蝈篝殇螬⒂翎螋溻秕麴豸镱翳玳鲥殇螽箦翩溻绛殇螵躅轱殇溻绛殇螵┅ㄤ彐躅躅溴怩é蝈篝殇螬⒂麸溻镱翳殇螽组翳铒殇蟋篝镳溻犰麸珏翳弪箦翩溻绛殇螵ㄩ铛祆殇螬铋箦舡溟骀弪孱沐溻绛殇螵殇螬┅换浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇ㄤ彐躅溻绛轭溴铘ㄩ轭溴铘骘蝽狒篝蜷铉蝈篝狎珞⑿蜷铘轭溴铘邃溴怩珑轭轭骘殒呐抡赡栳忮孱箴邈殒殄洚麒孱礤礅弪殇溻绛殇螵ㄦ蝈箬扉铄溴怩绛轱ㄤ雉轫弩ㄩ轭溴铘痱轭溴怩绛轱┅ㄡ痧禊＇骘蝽狒溴怩绛轱骘蝽狒篝蜷铉狎珞┅换换萧桢蚝换ㄤ彐躅箫螋箦痱邃脲脲⒂矧鏖翳秕犰翦蜷铉翳箦聃孱沐箫螋ㄣ镳箦箦瘵痱邃弘妁脲┅ㄤ彐躅蝈躞瀛泔铙⒁弭躜ㄣ镱┈矧蝈躞殒轸轶羼踽麸ㄣ镱ㄩㄡ钿ㄥ耢ㄣ狎┅ㄥ耢ㄣ潋┅ㄣ镱┅换浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇ㄤ彐躅戾铉翳奖⑸扉篝镦戾铉翳笨ㄡ钿ㄣ镱箴铛祆ㄣ潋┅┅ㄤ彐躅蝈篝扉篝⒃桢蝈篝镦扉篝徭翦翳骈蝮匀遗屐屙孱趔ㄣ滗潋扉篝┅换浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇ㄤ彐躅躅轳蹂骈钿殒犷麒弪痱邃殂狒趄邋镳糸镱犰骘躅洵箫驷颟⒁弭躜扉篝镦戾狯弩镦趄邋筢糸箧轭痱邃殂狒瀣鏖翳漉痨殂狒弩蝈盹鲥洚ㄩㄡ麸趄邋ㄩㄦ躅汜祆痱邃殂狒趄邋ㄡ潢镩趄邋骘躅洵箫驷颟骘躅洵箫驷颟躅轳蹂骈钿殒犷麒弪痱邃殂狒ㄦ轵篝趄邋躅轳蹂骈钿殒犷麒弪痱邃殂狒蝈篝趄邋骘躅洵箫驷颟┅ㄤ彐躅骈钿殒犷麒弪痱邃殂狒趄邋⒛镥痱邃殂狒狃痨麸犷狒镯轭翳趄邋竣ㄩㄡ麸趄邋ㄦ躅汜祆痱邃殂狒趄邋矧ㄦ轭洵殒犷麒弪痱邃殂狒ㄦ轵篝趄邋┅ㄦ轭洵殒犷麒弪痱邃殂狒蝈篝趄邋┅┅换浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇ㄤ彐磲泸溴骈铄孱蹴弪狒邃豉疱豉疱蝈篝屐屙孱趔⒁屦蝈箦铘犷孱蹴弪狒邃豉疱鏖翳轭翦珏蝮碍町啜痱镧ㄤ彐豉疱豉疱īЖ轭翦珏ō戾铉翳屐屙孱趔暴┅ㄤ彐躅ō倔礅镬豉疱Л倔礅镬ì豉疱ㄥ祠К屐屙孱趔豉疱┅ㄤ彐躅ō倔礅镬簌礅镬豉疱簌礅镬痫箝糸镱簌礅镬К屐屙孱趔┅括祜镳骘屐屙孱轭屐屙孱趔骘骝镯泔祆邈啜溴骛狎犴弭弪屐屙孱椹┅换浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇ㄤ彐躅铒舡铛祆铒铛祆┅ㄤ彐躅骈蝮舡矧铋⒃桢骈蝮屐屙孱镦殒轸轶扉篝屐箦铋飚ㄩㄣ镱箴ㄦ轵篝铋飑ㄤ彐躅骈蝮舡矧箦戽⒃桢骈蝮屐屙孱镦殒轸轶扉篝屐箦轸箦戽ㄩㄣ镱箴ㄦ轵篝┅换浇浇浇浇浇浇浇浇浇浇浇浇浇浇浇换换锰籼犷廖由锰蔑眇狒殁殪轸躅戾篌ㄦ怙躅漯т彐礤翳镤ㄤ彐磲泸溴骓弭栾钺礤狎珞蝈篝怙澌啜溴骢К钺礤К狎珞棱镤┅躅戾篌ㄦ怙躅漯ы狃轭麸ㄤ彐躅磲瓠轭麸蝈篚祠箦聃孱沐骢钽糸镱蝈篝箦聃孱沐螬⒛弩趄蹉糸鲥禊箦屐屙孱趔镦遗诱淘优颜盼门麸翳蝈篚祠镦狃痨轭普蚊陨衔麸蝈箴邈糸鲥屐屙孱趔镦优颜盼门赢戾è狎珈轶磲脲扉篝戾铉翳箦聃孱沐螬┅ㄩ扉篝蝈篚祠箦聃孱沐盹篝痫箝糸鲥骈铛ㄡ蝌狴溟礤铙轱蝈篚祠箦聃孱沐癌┅换狎珈轶轶磲溴轭麸扉篝镦狎珞骘遽汨汜祆换轶翳戾铉翳镦翳祜铉弩鲥泗矧麒孱箦聃孱沐箦翩黹祜镳骘箦轭箦聃孱沐黹铋黹戾铉翳箦瘵┅┅换腻骈铄箫礤箬狎邃骢钽糸镱蠛ㄦ戾è滹镱瀛汜祆ㄩ祜镳骘箦镱箦聃孱沐骘狎镱狎珈轶滹ㄩ扉篝ㄦ轵篝箦瘵箦翩ㄦ轵篝狎绌痫ㄦ轵篝箦瘵┅箦翩ㄦ轵篝狎绌ㄡ蝈ㄦ轵篝箦瘵椹┅ㄡ痧禊骢钽糸镱狎珈轶舂ㄤ锃蝈篚祠ㄩㄩㄡ钿鲥泗矧蝈篚祠箦聃孱沐ㄡ蝌狴栳蟓骈祆痫轭翦颦蝈篚祠箦聃孱沐┅箦翩ㄦ殪飙痫轭翦蝈篚祠箦聃孱沐磲ㄦ殪飙痫轭翦蝈篚祠箦聃孱沐┅┅┅ㄤ邈灬蝈ㄩ铎轭滹镱瀛汜祆┅换腻汩溴殒翳蝈篚祠轶扉篝矧鲥泗矧换犷祜镳翳蝻蹒遽汨屐屙孱ㄩ扉篝蝈篚祠箦聃孱沐祜镳骘骝镯麸ō暴骘镱蝈篚祠箦聃孱沐滹箦翩ㄦ轵篝颟ㄤ锃镱瀛汜祆椹骈钺祆ㄤ锃蝈篚祠椹祜镳骘骝镯麸ō暴滹箦翩ㄡ蝈蝈篚祠箦聃孱沐椹ㄤ锃镱瀛汜祆椹骈钺祆ㄤ锃蝈篚祠椹┅蝈篚祠箦聃孱沐┅躅戾篌ㄦ怙躅漯с镯痨屙孱舂ㄤ彐躅泔眇戾礤铘ㄦ瞟⑸莆蝈趱蝾翳孱ㄣ镯痨屙孱莆蝈趱蝾铒┊＇灬礅溽é蝈篝狎珞铒ㄡ痧禊骖狎珞┅┅躅戾篌ㄦ怙躅漯鏖翳泔眇殪狒轱瞽躅轸ㄤ彐磲泸鏖翳泔眇殪狒轱瞽躅轸镳糸镱怙澌怙澌⒛翳怙澌怩溴灬泔眇殪弪麽蝾轭珞躅糸翳孱洚换澡狒麽躅溴骈铄骢钽糸镱麽蝾轭珞翳狒狎蝈犰禊换牾篝骘蝼狎蝈驽蝈钽弩鏖祆铒忮痱轭翦狒犰飚换澡轶轶溴骈铄轭蔑眄镱涕箴翳提铉踽珏差邃ㄤ邈灬蝈ㄩ珙矧镳糸镱螬啜蝈徜糸礤汜箦＋涕箴с镯痖戾蚝泔眇殪弪麽蝾轭珞泔铘屮舡忾钿＋条汩鏖翳溴驽蝌邃麽蝾轭珞ю蝻珙怙澌┅换换义漉沐麒孱铋换描犷珏翳轶麸殒秕铄邃遗恼门鏖翳弘妁脲黠蜾ㄤ彐躅蝈漉沐ㄦ箦骝镯孱篝狎孱脲轭轸轭轸皓ㄦ躅汜祆ㄩ扉篝箦瘵＇蝈漉沐扉篝＇蝈漉沐鲥泗骖箦骝镯孱矧篝狎癌孱脲轭轸轭轸皓ㄤ彐躅蝈漉沐ㄦ躅泗轱箦聃孱沐脲骝镯孱篝狎孱脲ㄩ铋糸犰鲠祯铋轭轸獒飙鲠祯瀛皓蝈漉沐骢钽糸镱箦聃孱沐骝镯孱篝狎孱脲轭轸獒飙鲠祯轭轸獒飙鲠祯瀛皓ㄤ彐躅蝈漉沐鲥泗ㄦ箦骝镯孱篝狎孱脲轭轸轭轸皓ㄩ铛祆孱洎箦翩孱戾铉翳箦瘵┅ㄡ篌弪冀篝狎孱戾铉翳箦瘵篝狎孱洎⑸祆彗犰篚怏羼蹂钽镦后翎螋哄钿洧箦篝狎孱洎ㄣ狍ō孱篝狎舂ūㄩ轭轸ㄦ躅汜祆骖轭轸ㄦ躅汜祆殒脲ㄡ蝈箦篝狎舂┅ㄦ躅汜祆殒脲ㄡ蝈箦篝狎舂┅òㄩ轭轸轭轸ㄦ躅汜祆骖┅ㄩ铒骝镯孱洎戾è蝈篚祠ㄩ轭轸ㄦ躅汜祆骖轭轸ㄦ躅汜祆殒脲ㄡ蝈箦篝狎舂┅ㄦ躅汜祆骖ㄦ躅汜祆殒脲ㄡ蝈箦篝狎舂ㄦ躅汜祆殒脲ㄡ蝈箦ǐ篝狎暴┅┅┅祜镳骘骝镯ǐ篝狎ㄩ轭轸博麸ō孱暴滹箦翩蝈篚祠ㄦ躅汜祆骖蝈篚祠ㄦ躅汜祆殒脲ㄡ蝈箦椹┅┅蝈篚祠戾è蝈篚祠ㄩ轭轸ㄦ躅汜祆骖ㄦ躅汜祆殒脲ㄡ蝈箦ō孱暴┅轭轸ㄦ躅汜祆骖ㄦ躅汜祆殒脲ㄡ蝈箦ō孱博┅ㄦ躅汜祆殒脲ㄡ蝈箦ō孱暴┅┅┅祜镳骘骝镯ō孱ㄩ轭轸畅滹黝麸篝狎滹箦翩蝈篚祠ㄦ躅汜祆骖ㄦ躅汜祆殒脲ㄡ蝈箦椹蝈篚祠┅蝈篚祠┅┅ㄤ彐躅蝈漉沐扉篝ㄦ箦骝镯孱篝狎孱脲轭轸轭轸皓ㄩ铛祆孱洎箦翩孱戾铉翳箦瘵┅ㄣ镱è篝狎癌蝈漉沐扉篝骖铘桡潋篝狎箦瘵骝镯孱ō孱篝狎舂脲轭轸轭轸皓è矧铛祆箦瘵ㄥ耢篝狎孱洎ㄩ轭轸轭轸ㄦ躅汜祆骖┅èō孱篝狎舂暴ㄩ轭轸ㄦ躅汜祆骖轭轸ㄦ躅汜祆殒脲ㄦ轵篝箦瘵┅ㄦ躅汜祆殒脲ㄦ轵篝箦瘵┅ㄦ蝻憝孱蝈漉沐鲥泗骖ㄣ镥蜚箦鲥泗矧篝狎孱脲轭轸轭轸皓è铛祆蝈篝箦瘵ㄩ轭轸ㄦ躅汜祆骖轭轸ㄦ躅汜祆殒脲ㄦ轵篝箦瘵┅ㄦ躅汜祆殒脲ㄦ轵篝箦瘵┅戾è蝈篚祠ㄩ轭轸ㄦ躅汜祆骖轭轸ㄦ躅汜祆殒脲痫箦瘵┅ㄦ躅汜祆骖ㄦ躅汜祆殒脲痫箦瘵ㄦ躅汜祆殒脲痫箦瘵┅┅ㄩ孱祜镳蝈疱狒ō孱ㄩ轭轸博麒殪箦滹箦翩蝈篚祠ㄦ躅汜祆骖蝈篚祠ㄦ躅汜祆殒脲痫箦瘵┅┅祜镳麒殪箦滹箦翩蝈篚祠ㄦ躅汜祆骖蝈篚祠ㄦ躅汜祆殒脲痫箦瘵┅┅蝈篚祠┅┅