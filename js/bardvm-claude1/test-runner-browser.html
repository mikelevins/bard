<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bard VM Test Runner</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      margin: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    
    h1 {
      color: #4ec9b0;
    }
    
    .controls {
      margin: 20px 0;
      padding: 15px;
      background: #252526;
      border: 1px solid #3e3e42;
      border-radius: 4px;
    }
    
    button {
      background: #0e639c;
      color: white;
      border: none;
      padding: 8px 16px;
      margin-right: 10px;
      cursor: pointer;
      border-radius: 3px;
      font-family: inherit;
    }
    
    button:hover {
      background: #1177bb;
    }
    
    button:disabled {
      background: #3e3e42;
      cursor: not-allowed;
    }
    
    input[type="file"] {
      margin-right: 10px;
    }
    
    .test-result {
      margin: 10px 0;
      padding: 15px;
      background: #252526;
      border-left: 4px solid #007acc;
      border-radius: 3px;
    }
    
    .test-result.pass {
      border-left-color: #4ec9b0;
    }
    
    .test-result.fail {
      border-left-color: #f48771;
    }
    
    .test-result.error {
      border-left-color: #f48771;
      background: #332222;
    }
    
    .test-name {
      font-weight: bold;
      font-size: 1.1em;
      color: #4fc1ff;
      margin-bottom: 8px;
    }
    
    .test-info {
      color: #858585;
      margin: 5px 0;
    }
    
    .test-output {
      margin-top: 10px;
      padding: 10px;
      background: #1e1e1e;
      border-radius: 3px;
      overflow-x: auto;
    }
    
    .result-value {
      color: #ce9178;
    }
    
    .expected-value {
      color: #b5cea8;
    }
    
    .status {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 3px;
      font-weight: bold;
      margin-left: 10px;
    }
    
    .status.pass {
      background: #4ec9b0;
      color: #000;
    }
    
    .status.fail {
      background: #f48771;
      color: #000;
    }
    
    .summary {
      margin: 20px 0;
      padding: 15px;
      background: #252526;
      border: 2px solid #007acc;
      border-radius: 4px;
      font-size: 1.1em;
    }
    
    .error-stack {
      color: #f48771;
      white-space: pre-wrap;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <h1>ðŸš€ Bard VM Test Runner</h1>
  
  <div class="controls">
    <input type="file" id="fileInput" multiple accept=".json">
    <button id="runDirectBtn" onclick="runTests(false)">Run Direct</button>
    <button id="runWorkerBtn" onclick="runTests(true)">Run in Workers</button>
    <button id="clearBtn" onclick="clearResults()">Clear Results</button>
  </div>
  
  <div id="summary"></div>
  <div id="results"></div>

  <!-- Load VM modules -->
  <script src="structs.js"></script>
  <script src="opcodes.js"></script>
  <script src="globals.js"></script>
  <script src="vm.js"></script>

  <script>
    let testFiles = [];
    
    // File input handling
    document.getElementById('fileInput').addEventListener('change', (e) => {
      testFiles = Array.from(e.target.files);
      document.getElementById('summary').innerHTML = 
        `<div class="test-info">Loaded ${testFiles.length} test file(s)</div>`;
    });

    /**
     * Clear results display
     */
    function clearResults() {
      document.getElementById('results').innerHTML = '';
      document.getElementById('summary').innerHTML = '';
    }

    /**
     * Run a single test directly (no worker)
     */
    async function runTestDirect(testData) {
      // Clear globals
      clearGlobalVars();

      // Initialize globals if present
      if (testData.globals) {
        for (const [name, value] of Object.entries(testData.globals)) {
          setGlobalVar(name, value);
        }
      }

      // Create function
      const fn = new Fn({
        code: testData.code,
        name: testData.name || 'main',
        args: testData.args || []
      });

      // Run
      const result = machine(fn);
      return result;
    }

    /**
     * Run a single test in a worker
     */
    async function runTestWorker(testData) {
      return new Promise((resolve, reject) => {
        const worker = new Worker('worker-vm.js');
        
        worker.onmessage = (e) => {
          const msg = e.data;
          if (msg.type === 'result') {
            worker.terminate();
            resolve(msg.value);
          } else if (msg.type === 'error') {
            worker.terminate();
            reject(new Error(msg.error));
          }
        };

        worker.onerror = (err) => {
          worker.terminate();
          reject(err);
        };

        worker.postMessage({
          type: 'run',
          code: testData.code,
          name: testData.name || 'main',
          args: testData.args || [],
          globals: testData.globals || {},
          id: 1
        });
      });
    }

    /**
     * Display a test result
     */
    function displayResult(testData, result, elapsed, error = null) {
      const resultsDiv = document.getElementById('results');
      const resultDiv = document.createElement('div');
      
      let className = 'test-result';
      let statusText = '';
      let statusClass = '';

      if (error) {
        className += ' error';
        statusText = 'âœ— ERROR';
        statusClass = 'fail';
      } else if (testData.expected !== undefined) {
        const passed = JSON.stringify(result) === JSON.stringify(testData.expected);
        className += passed ? ' pass' : ' fail';
        statusText = passed ? 'âœ“ PASS' : 'âœ— FAIL';
        statusClass = passed ? 'pass' : 'fail';
      } else {
        className += ' pass';
        statusText = 'âœ“ COMPLETED';
        statusClass = 'pass';
      }

      resultDiv.className = className;
      
      let html = `
        <div class="test-name">
          ${testData.name || '(unnamed)'}
          <span class="status ${statusClass}">${statusText}</span>
        </div>
        <div class="test-info">Time: ${elapsed}ms</div>
      `;

      if (testData.description) {
        html += `<div class="test-info">Description: ${testData.description}</div>`;
      }

      if (error) {
        html += `
          <div class="test-output">
            <div class="error-stack">${error.message}\n${error.stack || ''}</div>
          </div>
        `;
      } else {
        html += `
          <div class="test-output">
            <div>Result: <span class="result-value">${JSON.stringify(result)}</span></div>
        `;

        if (testData.expected !== undefined) {
          html += `<div>Expected: <span class="expected-value">${JSON.stringify(testData.expected)}</span></div>`;
        }

        html += `</div>`;
      }

      resultDiv.innerHTML = html;
      resultsDiv.appendChild(resultDiv);

      return !error && (testData.expected === undefined || 
                        JSON.stringify(result) === JSON.stringify(testData.expected));
    }

    /**
     * Run all loaded tests
     */
    async function runTests(useWorker) {
      if (testFiles.length === 0) {
        alert('Please select test files first');
        return;
      }

      clearResults();

      const runBtn = useWorker ? 
        document.getElementById('runWorkerBtn') : 
        document.getElementById('runDirectBtn');
      runBtn.disabled = true;

      let passed = 0;
      let failed = 0;

      for (const file of testFiles) {
        try {
          // Read file
          const text = await file.text();
          const testData = JSON.parse(text);

          // Run test
          const startTime = performance.now();
          let result;
          let error = null;

          try {
            if (useWorker) {
              result = await runTestWorker(testData);
            } else {
              result = await runTestDirect(testData);
            }
          } catch (e) {
            error = e;
          }

          const endTime = performance.now();
          const elapsed = Math.round(endTime - startTime);

          // Display result
          const success = displayResult(testData, result, elapsed, error);
          if (success) {
            passed++;
          } else {
            failed++;
          }

        } catch (error) {
          failed++;
          const resultDiv = document.createElement('div');
          resultDiv.className = 'test-result error';
          resultDiv.innerHTML = `
            <div class="test-name">
              ${file.name}
              <span class="status fail">âœ— ERROR</span>
            </div>
            <div class="test-output">
              <div class="error-stack">${error.message}</div>
            </div>
          `;
          document.getElementById('results').appendChild(resultDiv);
        }
      }

      // Show summary
      const summaryDiv = document.getElementById('summary');
      summaryDiv.className = 'summary';
      summaryDiv.innerHTML = `
        <div><strong>Test Summary</strong></div>
        <div>Total: ${passed + failed}</div>
        <div>Passed: <span style="color: #4ec9b0">${passed}</span></div>
        <div>Failed: <span style="color: #f48771">${failed}</span></div>
        <div>Mode: ${useWorker ? 'Worker Threads' : 'Direct'}</div>
      `;

      runBtn.disabled = false;
    }
  </script>
</body>
</html>
